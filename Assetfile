require 'benoit/pipeline/dsl_extensions'

before_filter Benoit::Filters::MetadataCleaner

input Dir.pwd do

  reject "_*"
  reject ".git"
  reject ".gitignore"

  match "**/*{.markdown,.md,.mkdown,.mdown}" do
    filter Benoit::Filters::MarkdownFilter
  end

  match "**/*.js" do
    concat do |input|
      directory = File.dirname(input)
      "#{directory}/app.js"
    end
  end

  match "**/*.handlebars" do
    filter Rake::Pipeline::Web::Filters::HandlebarsFilter
    concat do |input|
      directory = File.dirname(input)
      js_dirs = Dir["**/*.js"].map { |js_file| File.dirname(js_file) }
      js_root = js_dirs.sort(&:length).first
      "#{js_root}/templates.js"
    end
  end

  match "*.scss" do
    filter Benoit::Filters::SassFilter, additional_load_paths: ["styles", "css"]
  end

  needs_pagination "*.html"

  match "**/*.html" do
    filter Benoit::Filters::ContentPageFilter
    filter Benoit::Filters::CadenzaFilter
  end

end

